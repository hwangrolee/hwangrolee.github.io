<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="https://hwangrolee.github.io//feed.xml" rel="self" type="application/atom+xml"/><link href="https://hwangrolee.github.io//" rel="alternate" type="text/html" hreflang="en"/><updated>2024-12-01T07:44:55+00:00</updated><id>https://hwangrolee.github.io//feed.xml</id><title type="html">blank</title><subtitle>개발을 좋아하는 이황로입니다. 스타트업에서 웹 프론트엔드/백엔드 업무 모두 경험을 했고 수많은 새로운 기능을 개발했으며 버그를 수정해왔습니다. 그리고 서비스가 불안정할 때 MySQL, Redis 등 시스템 퍼포먼스를 개선하여 안정화 시킨 경험이 있고 제가 좋아하는 업무입니다. </subtitle><entry><title type="html">Apple login 사용해보기</title><link href="https://hwangrolee.github.io//blog/apple-login-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0/" rel="alternate" type="text/html" title="Apple login 사용해보기"/><published>2024-12-01T00:00:00+00:00</published><updated>2024-12-01T00:00:00+00:00</updated><id>https://hwangrolee.github.io//blog/apple-login-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0</id><content type="html" xml:base="https://hwangrolee.github.io//blog/apple-login-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0/"><![CDATA[<h3 id="0-준비사항">0. 준비사항</h3> <p><a href="https://developer.apple.com/kr/news/?id=09122019b">애플 로그인 뉴스</a></p> <p>https://developer.apple.com/account 에서 필요한 정보를 알 수 있습니다.</p> <h3 id="1-ceriticates-ids--profile에서-세팅정보를-알수-있습니다">1. Ceriticates, IDs &amp; Profile에서 세팅정보를 알수 있습니다.</h3> <figure> <picture> <img src="/assets/img/posts/2024-12-01-apple-login/apple_login_1.webp" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Ceriticates, IDs &amp; Profile에서 세팅정보를 알수 있습니다." title="Ceriticates, IDs &amp; Profile에서 세팅정보를 알수 있습니다." loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h3 id="2-identifiers-탭에서-본인의-identifier를-선택하세요">2. Identifiers 탭에서 본인의 identifier를 선택하세요</h3> <figure> <picture> <img src="/assets/img/posts/2024-12-01-apple-login/apple_login_2.webp" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Identifiers 탭에서 본인의 identifier를 선택하세요" title="Identifiers 탭에서 본인의 identifier를 선택하세요" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h3 id="3-apple-id-prefix--team-id-bundle-id--client-id">3. Apple ID Prefix = Team ID, Bundle ID = Client ID</h3> <p>Apple ID Prefix는 Team ID 입니다.</p> <p>Bundle ID는 ClientId 입니다.</p> <figure> <picture> <img src="/assets/img/posts/2024-12-01-apple-login/apple_login_3.webp" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Apple ID Prefix=Team ID, Bundle ID=Client ID" title="Apple ID Prefix=Team ID, Bundle ID=Client ID" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h3 id="4-로그인-기능을-활성화하세요">4. 로그인 기능을 활성화하세요.</h3> <figure> <picture> <img src="/assets/img/posts/2024-12-01-apple-login/apple_login_4.webp" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="로그인 기능을 활성화하세요." title="로그인 기능을 활성화하세요." loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h3 id="5-keys-에서-애플-로그인을-위한-서비스를-생성하세요">5. Keys 에서 애플 로그인을 위한 서비스를 생성하세요</h3> <figure> <picture> <img src="/assets/img/posts/2024-12-01-apple-login/apple_login_5.webp" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Keys 에서 애플 로그인을 위한 서비스를 생성하세요" title="Keys 에서 애플 로그인을 위한 서비스를 생성하세요" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h3 id="6-key-id--private-key-를-확인하세요">6. key id &amp; private key 를 확인하세요.</h3> <p>Download 버튼을 클릭하면 private key 를 다운받으실 수 있습니다.</p> <figure> <picture> <img src="/assets/img/posts/2024-12-01-apple-login/apple_login_6.webp" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="key id &amp; private key 를 확인하세요." title="key id &amp; private key 를 확인하세요." loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h3 id="7-client_secret-을-구해보겠습니다">7. client_secret 을 구해보겠습니다.</h3> <p>jwt를 설치합니다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>gem <span class="nb">install </span>jwt
</code></pre></div></div> <p>아래 스크립트를 client_secret.rb 파일로 생성합니다.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'jwt'</span>
<span class="n">key_file</span> <span class="o">=</span> <span class="s1">'private_key.p8'</span>
<span class="n">team_id</span> <span class="o">=</span> <span class="s1">'team_id'</span>
<span class="n">client_id</span> <span class="o">=</span> <span class="s1">'client_id'</span>
<span class="n">key_id</span> <span class="o">=</span> <span class="s1">'key_id'</span>
<span class="n">ecdsa_key</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">EC</span><span class="p">.</span><span class="nf">new</span> <span class="no">IO</span><span class="p">.</span><span class="nf">read</span> <span class="n">key_file</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'kid'</span> <span class="o">=&gt;</span> <span class="n">key_id</span>
<span class="p">}</span>
<span class="n">claims</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'iss'</span> <span class="o">=&gt;</span> <span class="n">team_id</span><span class="p">,</span>
  <span class="s1">'iat'</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">to_i</span><span class="p">,</span>
  <span class="s1">'exp'</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">to_i</span> <span class="o">+</span> <span class="mi">86400</span><span class="o">*</span><span class="mi">180</span><span class="p">,</span>
  <span class="s1">'aud'</span> <span class="o">=&gt;</span> <span class="s1">'https://appleid.apple.com'</span><span class="p">,</span>
  <span class="s1">'sub'</span> <span class="o">=&gt;</span> <span class="n">client_id</span>
<span class="p">}</span>
<span class="n">token</span> <span class="o">=</span> <span class="no">JWT</span><span class="p">.</span><span class="nf">encode</span> <span class="n">claims</span><span class="p">,</span> <span class="n">ecdsa_key</span><span class="p">,</span> <span class="s1">'ES256'</span><span class="p">,</span> <span class="n">headers</span>
<span class="nb">puts</span> <span class="n">token</span>
</code></pre></div></div> <p>client_secret.rb 실행하여 client_secret 을 구합니다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ruby client_secret.rb
</code></pre></div></div> <blockquote class="block-tip"> <h5 id="tip">TIP</h5> <p>테스트할 때에는 웹을 사용하는데 그럴때에는 Client ID 에 Bundle ID가 아닌 Group ID를 넣어주면 더욱 편하게 테스트를 할 수있습니다.</p> </blockquote> <h3 id="8-토큰을-구하기-전에-먼저-사용자인증을-통해-code-값을-구합니다">8. 토큰을 구하기 전에 먼저 사용자인증을 통해 code 값을 구합니다.</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://appleid.apple.com/auth/authorize?response_type<span class="o">=</span>code&amp;client_id<span class="o">={</span>client_id<span class="o">}</span>&amp;redirect_uri<span class="o">={</span>redirect_uri<span class="o">}</span>
</code></pre></div></div> <figure> <picture> <img src="/assets/img/posts/2024-12-01-apple-login/apple_login_7.webp" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="토큰을 구하기 전에 먼저 사용자인증을 통해 code 값을 구합니다." title="토큰을 구하기 전에 먼저 사용자인증을 통해 code 값을 구합니다." loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <blockquote class="block-warning"> <h5 id="확인사항-1">확인사항 1</h5> <p>이 부분에서 상당히 시간소모를 했습니다. Client_id가 어떤것인지 애플쪽에서 정확히 명시하지 않아 헷갈려서 다른 값을 넣었고 에러코드가 client_id 가 틀리다고 나오질 않았기 때문에 다른 부분에서 문제가 있는줄 알고 구글서치만 수시간… 이 부분에서 redirect_uri를 입력했는데도 잘 안된다면 client_id 부터 의심하세요.</p> </blockquote> <blockquote class="block-warning"> <h5 id="확인사항-2">확인사항 2</h5> <p>만약 리디렉션됐는데도 Code가 안나온다면 response_mode, scope를 파라미터로 전달했는지 확인해보세요. response_mode와 scope를 전달하면 code를 받을 수 없습니다</p> </blockquote> <blockquote class="block-warning"> <h5 id="확인사항-3">확인사항 3</h5> <p>위 부분을 실행하면 xxx.com/?code={code} 형태로 리디렉션되며 code를 알 수 있습니다. 참고로 code는 5분간 유효한 키입니다.</p> </blockquote> <h3 id="9-code를-구했다면-이제는-access-token을-구할-수-있습니다">9. code를 구했다면 이제는 Access Token을 구할 수 있습니다.</h3> <p>id_token은 jwt로 인코딩되어있으며 https://jwt.io 에서 디코딩해서 데이터를 볼 수 있습니다.</p> <p>참고 : <a href="https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens?source=post_page-----a5b70fbf2f02--------------------------------">Generate and validate tokens</a></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-XPOST</span> <span class="s2">"https://appleid.apple.com/auth/token"</span> <span class="nt">-H</span> <span class="s2">"Content-Type: application/x-www-form-urlencoded"</span> <span class="nt">-d</span> <span class="s2">"client_id={client_id}&amp;client_secret={client_secret}&amp;grant_type=authorization_code&amp;code={code}"</span> | json_pp
<span class="o">{</span>
    <span class="s2">"refresh_token"</span> : <span class="s2">""</span>,
    <span class="s2">"expires_in"</span> : 3600,
    <span class="s2">"id_token"</span> : <span class="s2">""</span>,
    <span class="s2">"access_token"</span> : <span class="s2">""</span>,
    <span class="s2">"token_type"</span> : <span class="s2">"Bearer"</span>
<span class="o">}</span>
</code></pre></div></div> <p>이메일은 이메일 공유하기로 로그인한 경우 애플ID 로 보이고, 가리기를 선택한 경우 @private.appleid.com 으로 이메일이 생성되어집니다.</p> <p>sub라는 필드는 하나의 애플계정의 유니크한 값이니 이메일로 유저를 구분하지 않고 sub필드로 유저를 구분할 수 있습니다.</p> <h3 id="참고">참고</h3> <ul> <li><a href="https://sarunw.com/posts/sign-in-with-apple-4/">sign-in-with-apple-4</a></li> <li><a href="https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens">generate_and_validate_tokens</a></li> <li><a href="https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_rest_api/authenticating_users_with_sign_in_with_apple">authenticating_users_with_sign_in_with_apple</a></li> </ul>]]></content><author><name></name></author><category term="로그인"/><category term="애플로그인,"/><category term="AppleLogin"/><summary type="html"><![CDATA[Apple Login을 직접 구현하는 방법을 알아봅니다.]]></summary></entry></feed>